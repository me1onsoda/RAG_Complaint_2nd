import json
from langchain_ollama import ChatOllama
from langchain_core.prompts import ChatPromptTemplate

# 1. AI(Llama) ì¤€ë¹„
print("ðŸ¤– Llamaë¥¼ ê¹¨ìš°ê³  ìžˆìŠµë‹ˆë‹¤... (ìž ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)")
llm = ChatOllama(model="llama3.1", temperature=0)

# ==========================================
# [ì„¤ì •] 1. í‘œì¤€ ì¹´í…Œê³ ë¦¬ ëª©ë¡ (AIê°€ ì„ íƒí•  ì •ë‹µì§€)
# ==========================================
CATEGORIES = [
    "ë¶ˆë²•ì£¼ì°¨", "ë„ë¡œ/ì‹œì„¤ë¬¼", "ì²­ì†Œ/ì“°ë ˆê¸°", "ì†ŒìŒ/ì•…ì·¨", 
    "ê³µì›/ë…¹ì§€", "ê±´ì¶•/í—ˆê°€", "ë³´ê±´/ìœ„ìƒ", "êµí†µ/ë²„ìŠ¤", "ì„¸ê¸ˆ/í–‰ì •", "ê¸°íƒ€"
]

# ==========================================
# [ì„¤ì •] 2. 3ê°œ êµ¬ì²­ì˜ ì¡°ì§ë„ (ê°€ìƒì˜ DB ì—­í• )
# ì‹¤ì œë¡œëŠ” DBì—ì„œ 'ì¹´í…Œê³ ë¦¬'ì™€ ë§¤í•‘ëœ 'ë¶€ì„œëª…'ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
# ==========================================
DISTRICT_DB = {
    "ê°•ë‚¨êµ¬": {
        "ë¶ˆë²•ì£¼ì°¨": "ì£¼ì°¨ê´€ë¦¬ê³¼",      # ê°•ë‚¨ì€ 'ì£¼ì°¨ê´€ë¦¬ê³¼'
        "ë„ë¡œ/ì‹œì„¤ë¬¼": "ë„ë¡œê´€ë¦¬ê³¼",
        "ì²­ì†Œ/ì“°ë ˆê¸°": "ì²­ì†Œí–‰ì •ê³¼",
        "ë³´ê±´/ìœ„ìƒ": "ìœ„ìƒê³¼"
    },
    "ë§ˆí¬êµ¬": {
        "ë¶ˆë²•ì£¼ì°¨": "êµí†µì§€ë„ê³¼",      # ë§ˆí¬ëŠ” 'êµí†µì§€ë„ê³¼' (ê°•ë‚¨ê³¼ ë‹¤ë¦„!)
        "ë„ë¡œ/ì‹œì„¤ë¬¼": "í† ëª©ê³¼",       # ë§ˆí¬ëŠ” ë„ë¡œ ë¬¸ì œë¥¼ 'í† ëª©ê³¼'ì—ì„œ ë´„
        "ì²­ì†Œ/ì“°ë ˆê¸°": "ì²­ì†Œí–‰ì •ê³¼",
        "ë³´ê±´/ìœ„ìƒ": "ìœ„ìƒê³¼"
    },
    "ë…¸ì›êµ¬": {
        "ë¶ˆë²•ì£¼ì°¨": "êµí†µì§€ë„ê³¼",
        "ë„ë¡œ/ì‹œì„¤ë¬¼": "í† ëª©ê³¼",
        "ì²­ì†Œ/ì“°ë ˆê¸°": "ìžì›ìˆœí™˜ê³¼",   # ë…¸ì›ì€ ì²­ì†Œë¥¼ 'ìžì›ìˆœí™˜ê³¼'ë¼ê³  ë¶€ë¦„ (íŠ¹ì´í•¨)
        "ë³´ê±´/ìœ„ìƒ": "ë³´ê±´ìœ„ìƒê³¼"
    }
}

# ==========================================
# [ê¸°ëŠ¥ 1] AIê°€ ë¯¼ì› ë‚´ìš©ì„ ì½ê³  ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
# ==========================================
def classify_category(text):
    category_list_str = ", ".join(CATEGORIES)
    
    template = f"""
    ë„ˆëŠ” ë¯¼ì› ìžë™ ë¶„ë¥˜ ì‹œìŠ¤í…œì´ì•¼.
    ì•„ëž˜ [ë¯¼ì› ë‚´ìš©]ì„ ì½ê³ , ë‹¤ìŒ [ì¹´í…Œê³ ë¦¬ ëª©ë¡] ì¤‘ì—ì„œ ê°€ìž¥ ì ì ˆí•œ ê²ƒ í•˜ë‚˜ë§Œ ê³¨ë¼ì„œ ë‹¨ì–´ë¡œ ëŒ€ë‹µí•´.
    ì„¤ëª…ì€ í•˜ì§€ ë§ê³  ë”± ì¹´í…Œê³ ë¦¬ ëª…ì¹­ë§Œ ë§í•´.

    [ì¹´í…Œê³ ë¦¬ ëª©ë¡]
    {category_list_str}

    [ë¯¼ì› ë‚´ìš©]
    {{text}}
    """
    prompt = ChatPromptTemplate.from_template(template)
    chain = prompt | llm
    
    # AI ì‹¤í–‰
    response = chain.invoke({"text": text})
    result = response.content.strip()
    
    # í˜¹ì‹œ AIê°€ ì´ìƒí•œ ë§ì„ ì„žì„ê¹Œë´ ì²­ì†Œ
    for cat in CATEGORIES:
        if cat in result:
            return cat
    return "ê¸°íƒ€" # ëª» ì°¾ìœ¼ë©´ ê¸°íƒ€

# ==========================================
# [ê¸°ëŠ¥ 2] ë¶„ë¥˜ëœ ì¹´í…Œê³ ë¦¬ë¥¼ ë³´ê³  í•´ë‹¹ êµ¬ì²­ ë¶€ì„œ ì°¾ê¸°
# ==========================================
def find_department(district, category):
    # 1. í•´ë‹¹ êµ¬ì²­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    district_data = DISTRICT_DB.get(district)
    
    if not district_data:
        return "âŒ ì„œë¹„ìŠ¤í•˜ì§€ ì•ŠëŠ” ì§€ì—­ìž…ë‹ˆë‹¤."
    
    # 2. ì¹´í…Œê³ ë¦¬ì— ë§žëŠ” ë¶€ì„œ ì°¾ê¸°
    dept_name = district_data.get(category, "ë¯¼ì›ì—¬ê¶Œê³¼") # ì—†ìœ¼ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ë¯¼ì›ì—¬ê¶Œê³¼ë¡œ
    return dept_name

# ==========================================
# [ë©”ì¸] ì „ì²´ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
# ==========================================
if __name__ == "__main__":
    print("\nðŸš€ [ë¯¼ì› ìžë™ ë¶„ë¥˜ ë° ë¶€ì„œ ë°°ì • ì‹œìŠ¤í…œ] ê°€ë™\n")

    # í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 3ê°œ
    test_cases = [
        {"gu": "ê°•ë‚¨êµ¬", "complaint": "ë…¼í˜„ë™ ê³¨ëª©ì— ì°¨ë¥¼ ëˆ„ê°€ ëŒ€ê°ì„ ìœ¼ë¡œ ëŒ€ë†”ì„œ ì§€ë‚˜ê°ˆ ìˆ˜ê°€ ì—†ì–´ìš”. ê²¬ì¸ ì¢€ í•´ì£¼ì„¸ìš”."},
        {"gu": "ë§ˆí¬êµ¬", "complaint": "í™ëŒ€ìž…êµ¬ì—­ 3ë²ˆ ì¶œêµ¬ ì•ž ë„ë¡œì— êµ¬ë©ì´ í¬ê²Œ íŒŒì˜€ì–´ìš”. ë°œ ê±¸ë ¤ ë„˜ì–´ì§ˆ ë»”í–ˆìŠµë‹ˆë‹¤."},
        {"gu": "ë…¸ì›êµ¬", "complaint": "ì•„íŒŒíŠ¸ ë‹¨ì§€ ì•ž ì“°ë ˆê¸°í†µì´ ê½‰ ì°¨ì„œ ë„˜ì¹˜ê³  ëƒ„ìƒˆê°€ ë„ˆë¬´ ì‹¬í•©ë‹ˆë‹¤. ì–¸ì œ ì¹˜ìš°ë‚˜ìš”?"}
    ]

    for i, test in enumerate(test_cases):
        print(f"--- ðŸ§ª í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ {i+1} ---")
        print(f"ðŸ“ ìœ„ì¹˜: {test['gu']}")
        print(f"ðŸ“„ ë‚´ìš©: {test['complaint']}")
        
        # 1. AI ë¶„ë¥˜
        print("   â³ AIê°€ ë‚´ìš©ì„ ë¶„ì„ ì¤‘ìž…ë‹ˆë‹¤...")
        ai_category = classify_category(test['complaint'])
        print(f"   ðŸ·ï¸  AI íŒë‹¨ ì¹´í…Œê³ ë¦¬: [{ai_category}]")
        
        # 2. ë¶€ì„œ ë§¤í•‘
        final_dept = find_department(test['gu'], ai_category)
        print(f"   ðŸ¢ ìµœì¢… ë°°ì • ë¶€ì„œ: {test['gu']}ì²­ -> [{final_dept}]")
        print("-" * 40 + "\n")